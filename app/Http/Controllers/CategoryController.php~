<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Http\Requests\CategoryRequeust;
use App\Http\Requests\TranslationOfCategoryRequest;
use App\Http\Resources\CategoryListResource;
use App\Http\Resources\CategoryResource;
use App\Http\Resources\NonTranslatedCategoriesListResource;
use App\Http\Resources\nonTranslatedTourListResource;
use App\Models\Category;
use App\Models\CategoryTranslation;
use App\Traits\ImagesUtility;
use App\Traits\TourUtility;
use Exception;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\URL;
use Intervention\Image\Drivers\Gd\Driver;
use Intervention\Image\ImageManager;

class CategoryController extends Controller
{
    use TourUtility, ImagesUtility;

    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $locale = \request('locale', 'en');
        $categories = Category::whereHas('categoryTranslations', function ($query) use ($locale) {
            $query->where('locale', $locale);
        })->with(['categoryTranslations' => function ($query) use ($locale) {
            $query->where('locale', $locale);
        }])->get();
        return CategoryListResource::collection($categories);
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(CategoryRequeust $request)
    {
        //Validate Category
        $validatedCategoryData = $request->validated();
        $storedImage = $this->storeImage($validatedCategoryData['image'], 'category');
        $validatedCategoryData['image'] = $storedImage;
        $validatedCategoryData['description']=str_replace('target="_blank"', '', $validatedCategoryData['description']);
        $category = $this->createCategory($validatedCategoryData);
        $this->createCategoryTranslation($validatedCategoryData, $category->id);
        $category->load('categoryTranslations');
        return new CategoryResource($category);
    }

    /**
     * Display the specified resource.
     */
    public function show(string $category)
    {
        $locale=request('locale', 'en');
        $category = Category::find($category);
        $category->load(['categoryTranslations'=> function ($query) use ($locale) {
            $query->where('locale', $locale);
        }]);
        return new CategoryResource($category);
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(CategoryRequeust $request, Category $category)
    {
        $data = $request->all();
        if ($data['image'] ?? false)
        {
            if ($category->image ?? false) {
                $relativePath = $this->getRelativePath($category->image);
                Storage::delete($relativePath);
            }
            $data['image'] = $this->storeImage($data['image'], 'category');
        } else
        {
            $data['image'] = $category['image']; //34an lma agy 23ml insert myb2a5 null lo mfi4 image asln
        }
        $validatedCategoryData['description']=str_replace('target="_blank"', '', $validatedCategoryData['description']);
        $category->update($data);
        $this->updatecategoryTranslation($data, $data['categoryTranslationId']);
        return response()->json(['message' => 'Category updated successfully'], 200);
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(Category $category)
    {
        $category->delete();
        return response()->noContent();
    }

    public function getNonTranslatedCategories() {
        $nonTranslatedCategories=Category::whereDoesntHave('categoryTranslations', function ($query) {
            $query->where('locale', '!=', 'en');
        })->with('categoryTranslations')->get();
        return NonTranslatedCategoriesListResource::collection($nonTranslatedCategories);
    }

    public function translateNewCategory(TranslationOfCategoryRequest $request)
    {
        $validatedCategoryTranslationData = $request->validated();
        return $this->createCategoryTranslation($validatedCategoryTranslationData, $validatedCategoryTranslationData['category_id']);
    }

    public function receiveAndUpdateCategoryTranslation(TranslationOfCategoryRequest $request , $id)
    {
        $validatedCategoryTranslationData = $request->validated();
        $this->updateCategoryTranslation($validatedCategoryTranslationData, $id);
        return response()->json(['message' => 'Category updated successfully'], 200);
    }

    private function createCategory($data)
    {
        return Category::create([
            'type' => $data['type'],
            'image' => $data['image'],
        ]);
    }

    private function createCategoryTranslation($data, $categoryID)
    {
      return  CategoryTranslation::create([
            'name' => $data['name'],
            'header' => $data['header'],
            'bg_header' => $data['bg_header'],
            'description' => $data['description'],
            'title_meta' => $data['title_meta'],
            'description_meta' => $data['description_meta'],
            'locale' => $data['locale'],
            'category_id' => $categoryID
        ]);
    }

    private function updateCategoryTranslation($data, $categoryTranslationId)
    {
        CategoryTranslation::where('id', $categoryTranslationId)->update([
            'name' => $data['name'],
            'header' => $data['header'],
            'bg_header' => $data['bg_header'],
            'description' => $data['description'],
            'title_meta' => $data['title_meta'],
            'description_meta' => $data['description_meta'],
            'locale' => $data['locale'],
        ]);
    }

}
