<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Http\Requests\PageTextRequest;
use App\Http\Resources\PageTextResource;
use App\Models\PageText;
use Illuminate\Http\Request;

class PageTextsController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $locale = request('locale');
        return PageTextResource::collection(PageText::where('title->' . $locale, '!=', '')->get());
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(PageTextRequest $request)
    {
        $pageTextValidatedData = $request->validated();
        $createdText = PageText::create($pageTextValidatedData);
        return new PageTextResource($createdText);
    }

    public function createPageTextTranslation(Request $request, string $textId)
    {
        $pageText = PageText::find($textId);
        $pageTextTranslationData = $request->validate([
            'locale' => 'required',
            'content' => 'required|string',
        ]);
        if (!$pageText) {
            return response()->json('Page Text Not Found', 404);
        } else {
            $this->setPageTextTranslation($pageText, $pageTextTranslationData['locale'], $pageTextTranslationData);//update translatable attribute of blog
            return response()->json([
                'message' => 'Page Text Translation Created Successfully'
            ]);
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(string $textId)
    {
        $pageText = PageText::find($textId);
        return $pageText ? new PageTextResource($pageText) : response()->json('Page Text Not Found', 404);
    }

    public function getPageTextForTranslation(string $textId)
    {
        $pageText = PageText::find($textId);
        if (!$pageText) {
            return response()->json('$pageText Not Found', 404);
        }
        return response()->json([
            'id' => $pageText->id,
            'availableLocales' => array_diff(['en', 'fr', 'sp', 'zh', 'pt'], $pageText->locales()),
            'locale' => ''
        ]);
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, string $textId)
    {
        $pageText = PageText::find($textId);
        if (!$pageText) {
            return response()->json('Page Text Not Found', 404);
        } else {
            $pageTextTranslationData = $request->validate([
                'locale' => 'required',
                'content' => 'required|string',
            ]);
            $this->setPageTextTranslation($pageText, $pageTextTranslationData['locale'], $pageTextTranslationData);//update translatable attribute of blog
            return response()->json([
                'message' => 'Page Text Translation Updated Successfully'
            ]);
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(string $textId)
    {
        $pageText = PageText::find($textId);
        return $pageText ? $pageText->delete() : response()->json('Page Text Not Found', 404);
    }

    private function setPageTextTranslation(PageText $pageText, mixed $locale, $pageTextTranslationData)
    {
        $pageText->setTranslation('content', $locale, $pageTextTranslationData['content']);
        $pageText->save();
    }
}
