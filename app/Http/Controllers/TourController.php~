<?php

namespace App\Http\Controllers;

use App\Models\Category;
use App\Models\Review;
use App\Models\Tour;
use App\Traits\TourUtility;

class TourController extends Controller
{
    use TourUtility;

    public function index()
    {
        $CategoryType = \request('type');

        $category = Category::where('type', '=', $CategoryType)
            ->withCount('tours')->get();

        if ($CategoryType == 'tourPackages') {
            return view('TourPackage.index', compact('category'));
        }
        return view('Tours.index', compact('category'));
    }


    public function view($Category)
    {
        dd($Category);
        $tours = Tour::whereHas('category', function ($query) use ($Category) {
            $query->where('slug->' . app()->getLocale(), $Category)
                ->orWhere('slug->en', $Category);
        })
            ->with('category')
            ->get();

        return view('Tours.view', compact('tours'));
    }

    public function Tour($Cateogry, $Tour)
    {
        $tour = Tour::where('slug->' . app()->getLocale(), $Tour)
            ->orWhere('slug->en', $Tour)
            ->with(['images', 'category'])->first();
        $locations = $tour->getTranslation('locations', app()->getLocale());
        $tour->locations = implode('-', $tour->getTranslation('locations', app()->getLocale()));
        $this->storeIp(Request()->ip(), $tour->id);
        $reviews = Review::take(20)->get();
        $relatedTours = $this->getRelatedTours($locations, $tour->id, $tour->group);
        return view('Tour', compact('tour', 'reviews', 'relatedTours'));
    }

    public function getRelatedTours($locations, $id, $group)
    {
        return Tour::where(function ($query) use ($locations) {
            foreach ($locations as $location) {
                $query->whereJsonContains('locations->' . app()->getLocale(), $location)
                    ->orWhereJsonContains('locations->en', $location);
            }
        })
            ->where('group', $group)
            ->where('id', '!=', $id)
            ->with('category')
            ->inRandomOrder()
            ->get();
    }

}
